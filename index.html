<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chef Pro Horizontal - Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@400;700;900&display=swap');
        body { font-family: 'Prompt', sans-serif; background-color: #020617; }
        .bill-card { 
            min-width: 250px; 
            max-width: 280px;
            background: #1e293b;
            border-top: 8px solid #3b82f6;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-white p-4">
    <div class="max-w-full mx-auto">
        <div class="flex justify-between items-center mb-4 bg-slate-800 p-3 rounded-xl border-b-2 border-blue-500 shadow-lg">
            <h1 class="text-xl font-black text-blue-400">COMMAND CENTER 2.5</h1>
            <p id="status" class="text-green-400 text-sm font-bold italic">‚óè READY</p>
        </div>

        <div class="flex justify-center mb-6">
            <div class="relative w-full max-w-sm">
                <video id="video" autoplay playsinline muted class="w-full rounded-2xl border-2 border-slate-700"></video>
                <canvas id="canvas" class="hidden"></canvas>
                <button onclick="captureAndScan()" id="snapBtn" class="absolute -bottom-5 left-1/2 transform -translate-x-1/2 bg-blue-600 w-16 h-16 rounded-full border-4 border-slate-900 shadow-xl flex items-center justify-center active:scale-90 transition-all">
                    <span class="text-white font-black text-xs">SCAN</span>
                </button>
            </div>
        </div>

        <div class="mt-4">
            <div class="flex justify-between items-center mb-4 px-2">
                <h2 class="text-slate-400 font-bold uppercase text-sm">BILLS VIEW (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏™‡πÅ‡∏Å‡∏ô)</h2>
                <button onclick="clearOrders()" class="text-red-500 text-xs font-bold underline">‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
            
            <div id="orderQueue" class="flex flex-wrap gap-4 justify-start items-start pb-20">
                <div id="placeholder" class="text-slate-600 italic p-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤...</div>
            </div>
        </div>
    </div>

    <script>
        // ‡πÉ‡∏ä‡πâ Key ‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°
        let API_KEY = localStorage.getItem('chef_api_key') || "";
        const MODEL = "gemini-2.5-flash"; 

        async function setupCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                document.getElementById('video').srcObject = stream;
            } catch (err) { document.getElementById('status').innerText = "‚ùå ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á"; }
        }

        async function captureAndScan() {
            if(!API_KEY) {
                const key = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ä‡∏ü‡∏Ñ‡∏£‡∏±‡∏ö:");
                if(key) { localStorage.setItem('chef_api_key', key.trim()); location.reload(); }
                return;
            }

            const status = document.getElementById('status');
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const snapBtn = document.getElementById('snapBtn');

            status.innerText = "üåÄ ANALYZING...";
            snapBtn.disabled = true;

            const context = canvas.getContext('2d');
            canvas.width = 1024;
            canvas.height = video.videoHeight * (1024 / video.videoWidth);
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const base64Data = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];

            try {
                // ‡∏¢‡πâ‡∏≥ URL ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô v1 ‡∏ï‡∏≤‡∏°‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/${MODEL}:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [
                            { text: "‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏¥‡∏•: ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞, ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ï‡πà‡∏≠‡πÜ‡πÑ‡∏õ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏™‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ () ‡πÅ‡∏•‡∏∞ + ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ö‡∏¥‡∏•‡∏ï‡∏≠‡∏ö IGNORE" },
                            { inline_data: { mime_type: "image/jpeg", data: base64Data } }
                        ]}]
                    })
                });

                const data = await response.json();

                if (data.error) throw new Error(data.error.message);

                if (data.candidates && data.candidates[0].content) {
                    const result = data.candidates[0].content.parts[0].text.trim();
                    if (result !== "IGNORE") {
                        const cleanResult = result.replace(/[()+]/g, ' ');
                        addOrderToUI(cleanResult);
                        status.innerText = "‚óè READY";
                    } else {
                        status.innerText = "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ö‡∏¥‡∏•";
                    }
                } else {
                    throw new Error("AI ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤");
                }
            } catch (e) { 
                status.innerText = "‚ùå " + e.message;
                console.error(e);
            } finally {
                snapBtn.disabled = false;
            }
        }

        function addOrderToUI(text) {
            const queue = document.getElementById('orderQueue');
            const placeholder = document.getElementById('placeholder');
            if (placeholder) placeholder.remove();

            const lines = text.split('\n').filter(l => l.trim() !== "");
            const table = lines[0];
            const items = lines.slice(1).join('<br>');

            const card = document.createElement('div');
            card.className = "bill-card p-4 rounded-xl shadow-lg relative flex-none";
            card.innerHTML = `
                <div class="text-3xl font-black text-yellow-400 border-b border-slate-600 mb-2 pb-1 uppercase">${table}</div>
                <div class="text-xl font-bold text-white leading-tight min-h-[50px]">${items}</div>
                <button onclick="this.parentElement.remove()" class="absolute -top-3 -right-3 bg-red-600 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm shadow-md">‚úï</button>
            `;
            // ‡πÉ‡∏ä‡πâ appendChild ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å ‡∏ã‡πâ‡∏≤‡∏¢ ‡πÑ‡∏õ ‡∏Ç‡∏ß‡∏≤ ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô
            queue.appendChild(card);
        }

        function clearOrders() { if(confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) location.reload(); }

        setupCamera();
    </script>
</body>
</html>
