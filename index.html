<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chef Smart Station - Secure V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white p-4 font-sans text-lg">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-4xl font-black text-center mb-6 text-blue-400">üë®‚Äçüç≥ Kitchen Console 2.5</h1>
        
        <div id="keySetting" class="bg-slate-800 p-4 rounded-xl mb-6 border-2 border-dashed border-blue-500">
            <p class="text-sm mb-2 text-blue-200 text-center">üîë ‡πÉ‡∏™‡πà API Key ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ä‡∏ü‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡∏ó‡∏≥‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß):</p>
            <div class="flex gap-2">
                <input type="password" id="inputKey" placeholder="AIzaSy..." class="flex-1 p-2 rounded bg-slate-700 border border-slate-600">
                <button onclick="saveKey()" class="bg-blue-600 px-4 py-2 rounded font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>

        <div class="relative mb-6">
            <video id="video" autoplay playsinline muted class="w-full rounded-2xl border-4 border-slate-700"></video>
            <canvas id="canvas" class="hidden"></canvas>
            <button onclick="captureAndScan()" id="snapBtn" class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 bg-red-600 w-24 h-24 rounded-full border-8 border-gray-900 shadow-2xl flex items-center justify-center active:scale-95 transition-all">
                <span class="text-white font-black text-lg">SCAN</span>
            </button>
        </div>

        <div id="status" class="text-center text-xl mt-8 mb-4 text-yellow-400 font-bold h-10 italic font-bold">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
        <div id="orderQueue" class="space-y-6 pb-24 text-3xl font-bold"></div>
    </div>

    <script>
        let API_KEY = localStorage.getItem('chef_api_key') || "";
        const MODEL_NAME = "gemini-2.5-flash"; 

        if (API_KEY) {
            document.getElementById('keySetting').classList.add('hidden');
            document.getElementById('status').innerText = "Gemini 2.5 ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô!";
        }

        function saveKey() {
            const val = document.getElementById('inputKey').value;
            if (val) {
                localStorage.setItem('chef_api_key', val);
                API_KEY = val;
                document.getElementById('keySetting').classList.add('hidden');
                document.getElementById('status').innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô!";
            }
        }

        async function setupCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                document.getElementById('video').srcObject = stream;
            } catch (err) { alert("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö"); }
        }

        async function captureAndScan() {
            if (!API_KEY) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö!");
            
            const snapBtn = document.getElementById('snapBtn');
            const status = document.getElementById('status');
            const canvas = document.getElementById('canvas');
            const video = document.getElementById('video');

            status.innerText = "üåÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ö‡∏¥‡∏•...";
            snapBtn.disabled = true;
            snapBtn.style.opacity = "0.5";

            const context = canvas.getContext('2d');
            canvas.width = 800;
            canvas.height = video.videoHeight * (800 / video.videoWidth);
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const base64Data = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/${MODEL_NAME}:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [
                            { text: "‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏¥‡∏•‡∏™‡∏£‡∏∏‡∏õ‡πÇ‡∏ï‡πä‡∏∞‡πÅ‡∏•‡∏∞‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ö‡∏¥‡∏•‡∏ï‡∏≠‡∏ö IGNORE" },
                            { inline_data: { mime_type: "image/jpeg", data: base64Data } }
                        ]}]
                    })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                const result = data.candidates[0].content.parts[0].text.trim();
                if (result !== "IGNORE") {
                    const queue = document.getElementById('orderQueue');
                    queue.innerHTML = `<div class="bg-slate-800 p-6 rounded-2xl border-l-8 border-blue-500 mb-4">${result.replace(/\n/g, '<br>')}</div>` + queue.innerHTML;
                    status.innerText = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!";
                } else {
                    status.innerText = "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ö‡∏¥‡∏•";
                }
            } catch (err) {
                status.innerText = "‚ùå ‡∏û‡∏±‡∏á: " + err.message;
            } finally {
                snapBtn.disabled = false;
                snapBtn.style.opacity = "1";
            }
        }

        setupCamera();
    </script>
</body>
</html>
